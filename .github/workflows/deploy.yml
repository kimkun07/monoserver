name: Deploy to Server

on:
  push:
    branches: [ main ]
    paths:
      - 'compose.yaml'
      - 'nginx/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      working-directory: ./nginx-config-generator
      run: npm install

    - name: Generate Nginx configs
      working-directory: ./nginx-config-generator
      run: npm run generate

    - name: Check for changes
      id: check_changes
      run: |
        git add nginx/conf.d/
        git diff --cached --quiet nginx/conf.d/ || echo "changed=true" >> $GITHUB_OUTPUT

    - name: Commit generated configs
      if: steps.check_changes.outputs.changed == 'true'
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git add nginx/conf.d/
        git commit -m "chore: regenerate nginx configs

        Generated with [Claude Code](https://claude.ai/code)
        via [Happy](https://happy.engineering)

        Co-Authored-By: Claude <noreply@anthropic.com>
        Co-Authored-By: Happy <yesreply@happy.engineering>"
        git push

    - name: Deploy to Google Compute Engine
      if: github.ref == 'refs/heads/main'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.GCE_HOST }}
        username: ${{ secrets.GCE_USER }}
        key: ${{ secrets.GCE_SSH_KEY }}
        script_stop: true
        script: |
          set -e  # Exit immediately if a command exits with a non-zero status
          set -u  # Treat unset variables as an error
          set -o pipefail  # Catch errors in pipes

          echo "Starting deployment to GCE..."

          cd monoserver || { echo "❌ Error: monoserver directory not found"; exit 1; }

          # Pull latest changes
          echo "Pulling latest changes from main branch..."
          git pull origin main || { echo "❌ Error: git pull failed"; exit 1; }

          # Update Docker containers (only changed services will restart)
          echo "Updating Docker containers..."
          docker compose up -d || { echo "❌ Error: docker compose up failed"; exit 1; }

          # Wait a moment for containers to start
          sleep 3

          # Reload Nginx to pick up config changes (zero-downtime)
          echo "Reloading Nginx configuration..."
          docker compose exec monoserver-nginx-main nginx -s reload || { echo "❌ Error: nginx reload failed"; exit 1; }

          # Show status
          echo ""
          echo "=== Container Status ==="
          docker compose ps

          echo ""
          echo "=== Nginx Config Test ==="
          docker compose exec monoserver-nginx-main nginx -t || { echo "❌ Error: nginx config test failed"; exit 1; }

          echo ""
          echo "✅ Deployment completed successfully!"
