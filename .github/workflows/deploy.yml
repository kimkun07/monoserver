name: Deploy to Server

on:
  push:
    branches: [ main ]
    paths:
      - 'compose.yaml'
      - 'Caddyfile'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      working-directory: ./caddyfile-generator
      run: npm install

    - name: Generate Caddyfile
      working-directory: ./caddyfile-generator
      env:
        DOMAIN: ${{ secrets.GCE_HOST }}
      run: |
        if [ -z "$DOMAIN" ]; then
          echo "⚠️  Warning: GCE_HOST secret not set, using localhost"
          npm run generate
        else
          npm run generate -- --domain "$DOMAIN"
        fi

    - name: Check for changes
      id: check_changes
      run: |
        git add Caddyfile
        git diff --cached --quiet Caddyfile || echo "changed=true" >> $GITHUB_OUTPUT

    - name: Commit generated configs
      if: steps.check_changes.outputs.changed == 'true'
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git add Caddyfile
        git commit -m "chore: regenerate Caddyfile

        Generated with [Claude Code](https://claude.ai/code)
        via [Happy](https://happy.engineering)

        Co-Authored-By: Claude <noreply@anthropic.com>
        Co-Authored-By: Happy <yesreply@happy.engineering>"
        git push

    # IPv6 support (currently disabled, using IPv4 only)
    # - name: Set up WARP
    #   uses: fscarmen/warp-on-actions@v1.1
    #   with:
    #     stack: dual

    # - name: testing ipv6 for command
    #   run: |
    #     curl -m 9 --ipv6 --verbose https://google.com

    - name: Deploy to Google Compute Engine
      if: github.ref == 'refs/heads/main'
      uses: appleboy/ssh-action@v1.2.4
      with:
        host: ${{ secrets.GCE_HOST }}
        username: ${{ secrets.GCE_USER }}
        key: ${{ secrets.GCE_SSH_KEY }}
        timeout: 30s
        command_timeout: 30m
        # protocol: tcp6  # IPv6 support disabled, using default IPv4 (tcp)

        script: |
          set -e  # Exit immediately if a command exits with a non-zero status
          set -u  # Treat unset variables as an error
          set -o pipefail  # Catch errors in pipes

          echo "Starting deployment to GCE..."

          cd monoserver || { echo "❌ Error: monoserver directory not found"; exit 1; }

          # Pull latest changes
          echo "Pulling latest changes from main branch..."
          git pull origin main || { echo "❌ Error: git pull failed"; exit 1; }

          echo "Pulling latest Docker images..."
          docker compose pull || { echo "❌ Error: docker compose pull failed"; exit 1; }

          # Update Docker containers (only changed services will restart)
          echo "Updating Docker containers..."
          docker compose up -d || { echo "❌ Error: docker compose up failed"; exit 1; }

          # Wait a moment for containers to start
          sleep 3

          # Verify caddy container is running
          echo "Verifying caddy container is running..."
          if ! docker compose ps caddy | grep -q "Up\|running"; then
            echo "❌ Error: Caddy container failed to start"
            echo ""
            echo "Current container status:"
            docker compose ps caddy
            echo ""
            echo "Recent container logs:"
            docker compose logs --tail=50 caddy || true
            exit 1
          fi
          echo "✅ Caddy container is running"

          # Validate and reload Caddy to pick up config changes
          echo "Validating Caddy configuration..."
          docker compose exec -w /etc/caddy caddy caddy validate || { echo "❌ Error: caddy config validation failed"; exit 1; }

          echo "Reloading Caddy configuration..."
          docker compose exec -w /etc/caddy caddy caddy reload || { echo "❌ Error: caddy reload failed"; exit 1; }

          # Show status
          echo ""
          echo "=== Container Status ==="
          docker compose ps

          echo ""
          echo "✅ Deployment completed successfully!"
