services:
  monoserver-nginx-main: # [monoserver] Should not change name `monoserver-nginx-main`
    image: nginx:1.27.3
    ports:
    - "80:80"
    volumes:
    - type: bind
      source: ./nginx/nginx.conf
      target: /etc/nginx/nginx.conf
      read_only: true
    - type: bind
      source: ./nginx/routes.conf
      target: /etc/nginx/routes.conf
      read_only: true

  hello:
    image: hashicorp/http-echo
    command: ["-text=Hello from http-echo container!"]
    x-monoserver-port: "5678"

  whoami:
    image: traefik/whoami
    x-monoserver-port: "80"

  happy-server:
    image: kimkun07/happy-server-selfhost:latest
    environment:
      NODE_ENV: production
      DATABASE_URL: "postgresql://postgres:postgres@happy-postgres:5432/happy-server"
      REDIS_URL: "redis://happy-redis:6379"
      S3_HOST: happy-minio
      S3_PORT: "9000"
      S3_USE_SSL: "false"
      S3_ACCESS_KEY: "minioadmin"
      S3_SECRET_KEY: "minioadmin"
      S3_BUCKET: "happy-server"
      S3_PUBLIC_URL: "http://happy-minio:9000"
      HANDY_MASTER_SECRET: "monoserver-happy-server-secret-key-2026"
      PORT: "3000"
    depends_on:
      - happy-postgres
      - happy-redis
      - happy-minio
    restart: unless-stopped
    x-monoserver-port: "3000"

  happy-minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/data
    restart: unless-stopped
  
  happy-postgres:
    image: postgres:17
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: happy-server
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped

  happy-redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data
    restart: unless-stopped

volumes:
  postgres-data:
  redis-data:
  minio-data:
